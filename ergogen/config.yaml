# Copyright (c) 2025 Ã…smund Olai Sand-Larsen
# SPDX-License-Identifier: MIT
# To view a copy of this license, visit https://opensource.org/license/mit/

meta:
  engine: 4.1.0
units:
  d: 2
  d2: 6
  cutout: 14
points:
  key:
    padding: u
    bind: 1

  zones:
    matrix:
      anchor:
        shift: [100,-100]
        rotate: 8
      rows:
        bottom.row_net: P21
        home.row_net: P1
        top.row_net: P0
      columns:
        outer.key.column_net: P20
        pinkie.key:
          tags: pinkie
          column_net: P19
          spread: u
        ring.key:
          tags: ring
          column_net: P18
          stagger: 0.5cy
          spread: u+1.5
          splay: -4
        middle.key:
          tags: middle
          column_net: P15
          stagger: 0.5cy
          spread: u+1.5
          splay: -4
        index.key:
          column_net: P14
          spread: u+1.5
          stagger: -0.5cy
          splay: -4
        far.key:
          column_net: P10
          spread: u
    thumb:
      anchor:
        ref: matrix_index_bottom
        shift: [0, -u]
      rows.default.row_net: P9
      columns:
        outer.key.column_net: P15
        central.key:
          column_net: P14
          spread: u+4
          rotate: -15
          stagger: -4
        far.key:
          column_net: P10
          spread: u+2
          rotate: -25
          stagger: -8
    screws_left:
      key.padding: 2u
      anchor:
        ref: matrix_outer_bottom
        shift: [0.5u, -1]
      rows:
        top:
        bottom:
      columns.default:
    screws_right:
      key.padding: 2u
      anchor:
        ref: matrix_index_bottom
        shift: [0.5u, -1]
      rows:
        top:
        bottom:
      columns.default:
    screws_thumb:
      anchor:
        ref: thumb_central
        shift: [0.5u+2, -1]
    reset:
      anchor:
        ref: matrix_far_home
        shift: [2u-4, -u-9]

outlines:
  screws:
    - what: circle
      radius: 1
      where: [/^screws_.*/]
  _reset_hole:
    - what: circle
      radius: 0.5
      where: reset
  _raw:
    - what: polygon
      points:
        - ref: matrix_outer_top
          shift: [-0.5u-d, 0.5u+d]
        - ref: matrix_pinkie_top
          shift: [0.5u+d, 0.5u+d]
        - ref: matrix_ring_top
          shift: [-0.5u-d, 0.5u+d]
        - ref: matrix_ring_top
          shift: [0.5u+d, 0.5u+d]
        - ref: matrix_middle_top
          shift: [-0.5u-d, 0.5u+d]
        - ref: matrix_middle_top
          shift: [0.5u+d, 0.5u+d]
        - ref: matrix_index_top
          shift: [-0.5u-1.5d, 0.5u+d]
        - ref: matrix_far_top
          shift: [2u+1.25d, 0.5u+d]
        - ref: thumb_far
          shift: [0.5u+d, 0.5u+d]
        - ref: thumb_far
          shift: [0.5u+d, -0.5u-d]
        - ref: thumb_outer
          shift: [-0.5u-d, -0.5u-d]
        - ref: matrix_index_bottom
          shift: [-0.5u-d, -0.5u-d]
        - ref: matrix_ring_bottom
          shift: [0.5u+d, -0.5u-d]
        - ref: matrix_ring_bottom
          shift: [-0.5u+d, -0.5u-d]
        - ref: matrix_pinkie_bottom
          shift: [0.5u+d, -0.5u-d]
        - ref: matrix_outer_bottom
          shift: [-0.5u-d, -0.5u-d]
  outer_raw:
    - what: polygon
      points:
        - ref: matrix_outer_top
          shift: [-0.5u-d2, 0.5u+d2]
        - ref: matrix_pinkie_top
          shift: [0.5u-d, 0.5u+d2]
        - ref: matrix_ring_top
          shift: [-0.5u-d2, 0.5u+d2]
        - ref: matrix_ring_top
          shift: [0.5u-d, 0.5u+d2]
        - ref: matrix_middle_top
          shift: [-0.5u-d2, 0.5u+d2]
        - ref: matrix_middle_top
          shift: [0.5u+d2, 0.5u+d2]
        - ref: matrix_middle_top
          shift: [0.5u+d2, 1.25d2]
        - ref: matrix_far_top
          shift: [2u+1.25d2, 0.5u+d2]
        - ref: thumb_far
          shift: [0.5u+1.25d2, 0.5u+d]
        - ref: thumb_far
          shift: [0.5u+d2, -0.5u-d2]
        - ref: thumb_outer
          shift: [-0.5u-d2, -0.5u-d2]
        - ref: matrix_index_bottom
          shift: [-0.5u-d2, -0.5u-d2-1]
        - ref: matrix_ring_bottom
          shift: [0.5u+d2, -0.5u-d2]
        - ref: matrix_ring_bottom
          shift: [-0.5u+d2, -0.5u-d2]
        - ref: matrix_pinkie_bottom
          shift: [0.5u+d2, -0.5u-d2]
        - ref: matrix_outer_bottom
          shift: [-0.5u-d2, -0.5u-d2]
  _cutout:
    - what: outline
      name: _raw
      fillet: 1.5
  _outer:
    - what: outline
      name: outer_raw
      fillet: 1
  _switch_outlines:
    - what: rectangle
      where: [/^matrix_.*/, /^thumb_.*/]
      size: [cutout, cutout]
  _keycap_outlines:
    - what: rectangle
      where: [/^matrix_.*/, /^thumb_.*/]
      size: [u-0.5, u-0.5]
  _mcubb:
    - what: polygon
      points:
        - ref: matrix_far_top
          shift: [0.5u+10, 0.5u+d]
        - ref: matrix_far_top
          shift: [2u+1.25d, 0.5u+d]
        - ref: matrix_far_bottom
          shift: [2u+1.25d, -0.75u-d]
        - ref: matrix_far_bottom
          shift: [0.5u+10, -0.5u]
  _mcubb_outer:
    - what: polygon
      fillet: 1
      points:
        - ref: matrix_far_top
          shift: [0.5u+6, 0.5u+d2]
        - ref: matrix_far_top
          shift: [2u+1.25d2, 0.5u+d2+0.01]
        - ref: matrix_far_bottom
          shift: [2u+1.25d2, -0.75u-1.5d2]
        - ref: matrix_far_bottom
          shift: [0.5u+6, -0.5u-1.5d]
  mcubb_wall:
    - what: outline
      name: _mcubb_outer
    - what: outline
      name: _mcubb
      operation: subtract
      fillet: 1
  preview:
    - what: outline
      name: _cutout
    - what: outline
      name: _keycap_outlines
      operation: subtract
  _plate:
    - what: outline
      name: _raw
    - what: outline
      name: _switch_outlines
      operation: subtract
    - what: outline
      name: _mcubb_outer
      operation: subtract
    - what: outline
      name: screws
      operation: subtract
  plate_preview:
    - what: outline
      name: _plate
  case_wall:
    - what: outline
      name: _outer
    - what: outline
      name: _raw
      operation: subtract
  lid:
    - what: outline
      name: outer_raw
    - what: outline
      name: _mcubb_outer
      operation: subtract
  usb_cutout:
    - what: rectangle
      where: matrix_far_home
      size: [10, 5]
      corner: 2

pcbs:
  pcb:
    template: kicad8
    outlines:
      - outline: _cutout
    footprints:
      # Nice nano
      - where: matrix_far_top
        what: ceoloide/mcu_nice_nano
        adjust:
          shift: [u+11, -6.7]
        params:
          reversible: true
      # Battery
      - where: matrix_far_home
        what: ceoloide/battery_connector_jst_ph_2
        adjust:
          shift: [1.3u, -u-7]
          rotate: 180
        params:
          reversible: true
      # Power switch
      - where: matrix_far_home
        what: ceoloide/power_switch_smd_side
        adjust:
          shift: [2u+0.8, -u+2]
        params:
          from: BAT_P
          to: RAW
          reversible: true
          invert_behavior: false
      # Reset button
      # - where: reset
      #   what: SW_B3U-1000P
      #   adjust:
      #     rotate: -90
      #   params:
      #     P1: GND
      #     P2: RST
      #     reversible: true
      # Diodes
      - where: [/^matrix_.*/, /^thumb_.*/]
        what: ceoloide/diode_tht_sod123
        params:
          from: "{{colrow}}"
          to: "{{row_net}}"
          reversible: true
          include_traces_vias: true
        adjust:
          shift: [0,-5]
      # Switches
      - where: [/^matrix_.*/, /^thumb_.*/]
        what: ceoloide/switch_choc_v1_v2
        params:
          from: "{{column_net}}"
          to: "{{colrow}}"
          reversible: true
          include_corner_marks: true
          choc_v1_support: false
      
      # Screw holes
      - where: [/^screws_.*/]
        what: ceoloide/mounting_hole_plated

cases:
  plate:
    - what: outline
      name: _plate
      extrude: 1.6
  usb_cutout:
    - what: outline
      name: usb_cutout
      extrude: 6
      rotate: [90, -4, -4]
      shift: [u+14,2u-5,15]
  wall:
    - what: outline
      name: case_wall
      extrude: 11.6
  mcubb_wall:
    - what: outline
      name: mcubb_wall
      extrude: 10
      shift: [0,0,10]
  mcubb_top:
    - what: outline
      name: _mcubb_outer
      shift: [0, 0, 20]
      extrude: 4
  bottom:
    - what: outline
      name: _raw
      extrude: 3
    - what: outline
      name: _reset_hole
      extrude: 3
      operation: subtract
  upper:
    - what: case
      name: plate
      shift: [0,0,10]
    - what: case
      name: wall
    - what: case
      name: mcubb_wall
    - what: case
      name: mcubb_top
    - what: case
      name: usb_cutout
      operation: subtract
  case:
    - what: case
      name: upper
    - what: case
      name: bottom
  lid:
    - what: outline
      name: lid
      extrude: 9
      shift: [0,0,15]
