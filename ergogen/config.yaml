# Copyright (c) 2025 Ã…smund Olai Sand-Larsen
# SPDX-License-Identifier: MIT
# To view a copy of this license, visit https://opensource.org/license/mit/

# TODO:
  # Add vias for connecting the battery connector nets
  # Add screw holes

meta:
  engine: 4.1.0
units:
  d: 2
  d2: 6
  cutout: 14
points:
  key:
    padding: cy
    bind: 1

  zones:
    matrix:
      anchor:
        shift: [100,-100]
      rows:
        bottom:
          key:
            row_net: P10
        home:
          key:
            row_net: P3
        top:
          key:
            row_net: P1
      columns:
        outer:
          key:
            column_net: P7
        pinkie:
          key:
            tags: pinkie
            column_net: P2
            spread: cx
        ring:
          key:
            tags: ring
            column_net: P5
            stagger: 0.5cy
            spread: cx+1.5
            splay: -4
        middle:
          key:
            tags: middle
            column_net: P6
            stagger: 0.5cy
            spread: cx+1.5
            splay: -4
        index:
          key:
            column_net: P8
            spread: cx+1.5
            stagger: -0.5cy
            splay: -4
        far:
          key:
            column_net: P9
            spread: cx
    thumb:

      anchor:
        ref: matrix_index_bottom
        shift: [0, -cy]
      rows:
        row:
          key:
            row_net: P11
      columns:
        outer:
          key:
            column_net: P6
        central:
          key:
            column_net: P8
            spread: cx+4
            rotate: -15
            stagger: -4
        far:
          key:
            column_net: P9
            spread: cx+2
            rotate: -25
            stagger: -8

outlines:
  _raw:
    - what: polygon
      points:
        - ref: matrix_outer_top
          shift: [-0.5cx-d, 0.5cy+d]
        - ref: matrix_pinkie_top
          shift: [0.5cx+d, 0.5cy+d]
        - ref: matrix_ring_top
          shift: [-0.5cx-d, 0.5cy+d]
        - ref: matrix_ring_top
          shift: [0.5cx+d, 0.5cy+d]
        - ref: matrix_middle_top
          shift: [-0.5cx-d, 0.5cy+d]
        - ref: matrix_middle_top
          shift: [0.5cx+d, 0.5cy+d]
        - ref: matrix_middle_top
          shift: [0.5cx+d, 1.25d]
        - ref: matrix_far_top
          shift: [2cx+1.25d, 0.5cy+d]
        - ref: thumb_far_row
          shift: [0.5cx+d, 0.5cy+d]
        - ref: thumb_far_row
          shift: [0.5cx+d, -0.5cy-d]
        - ref: thumb_outer_row
          shift: [-0.5cx-d, -0.5cy-d]
        - ref: matrix_middle_bottom
          shift: [0.5cx-d, -0.5cy-d]
        - ref: matrix_middle_bottom
          shift: [-0.5cx+d, -0.5cy-d]
        - ref: matrix_ring_bottom
          shift: [0.5cx+d, -0.5cy-d]
        - ref: matrix_ring_bottom
          shift: [-0.5cx+d, -0.5cy-d]
        - ref: matrix_pinkie_bottom
          shift: [0.5cx+d, -0.5cy-d]
        - ref: matrix_outer_bottom
          shift: [-0.5cx-d, -0.5cy-d]
  outer_raw:
    - what: polygon
      points:
        - ref: matrix_outer_top
          shift: [-0.5cx-d2, 0.5cy+d2]
        - ref: matrix_pinkie_top
          shift: [0.5cx-d, 0.5cy+d2]
        - ref: matrix_ring_top
          shift: [-0.5cx-d2, 0.5cy+d2]
        - ref: matrix_ring_top
          shift: [0.5cx-d, 0.5cy+d2]
        - ref: matrix_middle_top
          shift: [-0.5cx-d2, 0.5cy+d2]
        - ref: matrix_middle_top
          shift: [0.5cx+d2, 0.5cy+d2]
        - ref: matrix_middle_top
          shift: [0.5cx+d2, 1.25d2]
        - ref: matrix_far_top
          shift: [2cx+1.25d2, 0.5cy+d2]
        - ref: thumb_far_row
          shift: [0.5cx+1.25d2, 0.5cy+d]
        - ref: thumb_far_row
          shift: [0.5cx+d2, -0.5cy-d2]
        - ref: thumb_outer_row
          shift: [-0.5cx-d2, -0.5cy-d2]
        - ref: matrix_middle_bottom
          shift: [0.5cx-d2, -0.5cy-d2]
        - ref: matrix_middle_bottom
          shift: [-0.5cx+d2, -0.5cy-d2]
        - ref: matrix_ring_bottom
          shift: [0.5cx+d2, -0.5cy-d2]
        - ref: matrix_ring_bottom
          shift: [-0.5cx+d2, -0.5cy-d2]
        - ref: matrix_pinkie_bottom
          shift: [0.5cx+d2, -0.5cy-d2]
        - ref: matrix_outer_bottom
          shift: [-0.5cx-d2, -0.5cy-d2]
  _cutout:
    - what: outline
      name: _raw
      fillet: 1
  _outer:
    - what: outline
      name: outer_raw
      fillet: 1
  _switch_outlines:
    - what: rectangle
      where: true
      size: [cutout, cutout]
  _keycap_outlines:
    - what: rectangle
      where: true
      size: [cx-0.5, cy-0.5]
  _mcubb:
    - what: polygon
      points:
        - ref: matrix_far_top
          shift: [0.5cx+2d+1, 0.5cy+d]
        - ref: matrix_far_top
          shift: [2cx+1.25d, 0.5cy+d]
        - ref: matrix_far_bottom
          shift: [2cx+1.25d, -0.75cy-d]
        - ref: matrix_far_bottom
          shift: [0.5cx+2d+1, -0.5cy]
  _mcubb_outer:
    - what: polygon
      points:
        - ref: matrix_far_top
          shift: [0.5cx+d, 0.5cy+d2+0.5]
        - ref: matrix_far_top
          shift: [2cx+1.25d2, 0.5cy+d2]
        - ref: matrix_far_bottom
          shift: [2cx+1.25d2, -0.75cy-1.5d2]
        - ref: matrix_far_bottom
          shift: [0.5cx+d, -0.5cy-1.5d]
  mcubb_wall:
    - what: outline
      name: _mcubb_outer
    - what: outline
      name: _mcubb
      operation: subtract
  preview:
    - what: outline
      name: _cutout
    - what: outline
      name: _keycap_outlines
      operation: subtract
  plate:
    - what: outline
      name: _cutout
    - what: outline
      name: _switch_outlines
      operation: subtract
    - what: outline
      name: _mcubb
      operation: subtract
    - what: outline
      name: mcubb_wall
      operation: subtract
  case:
    - what: outline
      name: _outer
    - what: outline
      name: _raw
      operation: subtract
  lid:
    - what: outline
      name: outer_raw
    - what: outline
      name: _mcubb_outer
      operation: subtract

  usb_cutout:
    - what: rectangle
      where: matrix_far_home
      size: [10, 5]
      corner: 2

pcbs:
  pcb:
    template: kicad8
    outlines:
      - outline: _cutout
    footprints:
      # Nice nano
      - where: matrix_far_home
        what: ceoloide/mcu_nice_nano
        adjust:
          shift: [cx+7, 8.3]
        params:
          reversible: true
      # Battery
      - where: matrix_far_home
        what: ceoloide/battery_connector_jst_ph_2
        adjust:
          shift: [1.3cx, -cy-7]
          rotate: 180
        params:
          reversible: true
      # Power switch
      - where: matrix_far_home
        what: ceoloide/power_switch_smd_side
        adjust:
          shift: [2cx+0.8, -cy+2]
        params:
          from: pos
          to: RAW
      # Reset button
      - where: matrix_far_home
        what: SW_B3U-1000P
        adjust:
          shift: [2cx+0.7, -cy-9]
          rotate: -90
        params:
          P1: GND
          P2: RST
          reversible: true
      # Diodes
      - where: true
        what: ceoloide/diode_tht_sod123
        params:
          from: =colrow
          to: =row_net
        adjust:
          shift: [0,-5]
      # Switches
      - where: true
        what: ceoloide/switch_choc_v1_v2
        params:
          from: =column_net
          to: =colrow
          reversible: true
          include_corner_marks: true
          choc_v1_support: false

cases:
  plate:
    - what: outline
      name: plate
      extrude: 3
  
  usb_cutout:
    - what: outline
      name: usb_cutout
      extrude: 100
      rotate: [90, -12, 0]
      shift: [cx+9.25,5cy,10]
  wall:
    - what: outline
      name: case
      extrude: 15
  mcubb_wall:
    - what: outline
      name: mcubb_wall
      extrude: 10
      shift: [0,0,10]
  mcubb_top:
    - what: outline
      name: _mcubb_outer
      shift: [0, 0, 20]
      extrude: 4
  bottom:
    - what: outline
      name: _cutout
      extrude: 3
  upper:
    - what: case
      name: plate
      shift: [0,0,10]
    - what: case
      name: wall
    - what: case
      name: mcubb_wall
    - what: case
      name: mcubb_top
    - what: case
      name: usb_cutout
      operation: subtract
  case:
    - what: case
      name: upper
    - what: case
      name: bottom
  lid:
    - what: outline
      name: lid
      extrude: 9
      shift: [0,0,15]
